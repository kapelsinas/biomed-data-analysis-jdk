---
title: "Praktinė užduotis Nr. 3"
author: "Jaroslav Rutkovskij, Danielė Stasiūnaitė, Karolis Augustauskas (JDK)"
date: "`r format(Sys.time(), '%d/%m/%y')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
subtitle: Hipotezių testavimas
---

```{r Figure_size, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(fig.height = 13, fig.width = 16)
```

```{r Preparations, warning=FALSE, include=FALSE}
library(pacman)
p_load(dplyr, ggplot2, reshape2, reshape, data.table, stringi)
```

```{r Data_access, warning=FALSE, include=FALSE}
beta <- readRDS("dat8.Rds")               # Modification value matrix
pData_col <- readRDS("pData.Rds")         # Sample (column) matrix
annot_row <- readRDS("annotation.Rds")    # Position (row) matrix
samples <- read.csv("samples2.csv")

colnames(beta) <- samples$graph_name[match(colnames(beta), samples$Basename)]
```

# 1. Statistinis hipotezių testavimas vidurkių palyginimui

### APRAŠYMO VIETA ###
# Aprašyti, kiek moterų įeina į aspiriną vartojančių ir aspirino nevartojančių
# moterų grupes (atlikus ankstesnes užduotis dalis mėginių buvo pašalinta, tad
# dabar aspiriną vartojančių ir nevartojančių moterų skaičius yra pakitęs)!!!

# Pateikti lentelę, kiek moterų įeina į asprino nevartojančių ir aspiriną
# vartojančių moterų grupes (prieš ir po (čia turima omenyje, kiek moterų įėjo
# į tas pačias grupes prieš mėginių šalinimą ir atlikus mėginių šalinimą))

```{r Aspirin_user/nonuser_selection, warning=FALSE, include=FALSE}
# Extracting data frame rows that describe aspirin non-users:
aspirin_nonusers <- samples[samples$aspirin == 'nonuser', ]$graph_name

# Extracting data frame rows that describe aspirin longterm users:
aspirin_users <- samples[samples$aspirin == 'longterm', ]$graph_name

# Extracting matrix columns that store aspirin non-user modification values
# (from beta matrix):
beta_nonusers <- beta[, colnames(beta) %in% aspirin_nonusers]

# Extracting matrix columns that store aspirin non-user modification values
# (from beta matrix):
beta_users <- beta[, colnames(beta) %in% aspirin_users]
```

# T.test. Reikalingas trumpas paaiškinimas, kodėl jį atliekam ir ką
# jis duoda (aiškinti kaip medikui, o ne kaip dėstytojui).

# Efekto dydžio skaičiavimas. Truputį aprašyti, kas tas efekto dydis,
# kodėl jį atliekam ir nurodyti, kad yra toks Cohen's d testas, leidžiantis
# apskaičiuoti efekto dydį. Jokių būdu neaprašinėti techniškai, bet aiškiai
# ir suprantamai, paaiškinant pagrindinę esmę.

```{r T_test_effect_size_calculations, warning=FALSE, include=FALSE}
# Creating an empty dataframes that will store p values and effect sizes
# for each position:
pvalues <- data.frame()
effect_sizes <- data.frame()

# Running a loop that performs t-test, effect size calculations and appends
# p-values, effect size values into dataframes:
for (row in 1:10000) {
  vec1 <- c(beta_nonusers[row, ])
  vec2 <- c(beta_users[row, ])
  rowname <- rownames(beta_nonusers)[row]
  
  row_pvalue <- c(rowname, t.test(vec1, vec2)$p.value)
  effect_size <- c(rowname, (mean(vec1) - mean(vec2)) /
                     sqrt((var(vec1) + var(vec2)) / 2))
  #print(row_pvalue)
  #print(effect_size)
  effect_sizes <- rbind(effect_sizes, effect_size)
  pvalues <- rbind(pvalues, row_pvalue)
}

pvalues <- pvalues %>% setNames(., c("Position", "P_value"))
effect_sizes <- effect_sizes %>% setNames(., c("Position", "Effect_size"))
```

# Paaiškinti, ką atvaizduoja ši histograma, interpretuoti ją ir panašiai.

```{r P_value_histogram, echo=FALSE, warning=FALSE}
values <- as.numeric(pvalues$P_value)
p_df <- data.frame(positions = c(pvalues$Position), pvals = values)

p1 <- ggplot(p_df, aes(x = pvals)) + 
        geom_histogram(binwidth = 0.025, color = "#00004d", fill = "#2f4581") +
        labs(x = "P value", y = "Count",
             title = "P-value distribution histogram") +
        theme(axis.text.x = element_text(vjust = 0.5),
              plot.title = element_text(hjust = 0.5, face = "bold"),
              panel.background = element_rect(colour = "#05076a", size = 0.5,
                                              fill = "#eaeafd",
                                              linetype = "solid"),
              panel.grid.major = element_line(size = 0.1, linetype = 'dashed',
                                              colour = "#05076a"), 
              panel.grid.minor = element_line(size = 0.1, linetype = 'dashed',
                                              colour = "#05076a"))
print(p1)
```

# Pakomentuoti, koks veiksmas buvo padarytas toliau, kodėl jis buvo daromas bei
# koks rezultatas buvo gautas.

```{r Min_p_value_visualization, echo=FALSE, warning=FALSE}
# Ordering a p-value dataframe and extracting 5 rows with the lowest p-value:
#min_Ps <- p_df[order(p_df$pvals),][1:5,]

# Determining position names that have the lowest p-values:
position_names <- p_df[order(p_df$pvals),][1:5,]$positions

nonuser_len <- length(colnames(beta_nonusers))
user_len <- length(colnames(beta_users))

# Creating dataframes with modification values of 5 positions (cg01760763,
# cg20768358, cg07179016, cg14510359, cg04083753):
anon_users <- beta_nonusers[position_names, ] %>%
                `colnames<-`(c(rep("Aspirin_nonusers", nonuser_len))) %>%
                melt()

a_users <- beta_users[position_names, ] %>%
              `colnames<-`(c(rep("Aspirin_users", user_len))) %>%
              melt()

# Combining two dataframes (of aspirin non-users and aspirin users) into one:
group_modifications <- rbind(anon_users, a_users) %>%
                          setNames(., c("Position", "User_nonuser",
                                   "Modification_value"))

p2 <- ggplot(group_modifications, aes(x = User_nonuser, y = Modification_value,
                                      color = Position)) +
        geom_point() +
        labs(title = "DNA modification values",
             subtitle = "5 positions with the lowest p values",
             x = "Aspirin user/non-user", y = "Modification value") +
        facet_grid(. ~ Position) +
        theme(axis.text.x = element_text(angle = 45, vjust = 0.5, size = 8),
              plot.title = element_text(hjust = 0.5, face = "bold"),
              plot.subtitle = element_text(hjust = 0.5, face = "bold"),
              panel.background = element_rect(colour = "#05076a", size = 0.5,
                                              fill = "#eaeafd",
                                              linetype = "solid"),
              panel.grid.major = element_line(size = 0.08, linetype = 'dashed',
                                              colour = "#05076a"), 
              panel.grid.minor = element_line(size = 0.08, linetype = 'dashed',
                                              colour = "#05076a"),
              strip.background = element_rect(fill = "#2f4581"),
              strip.text = element_text(color = "white", face = "bold"),
              legend.position = "none")

print(p2 + scale_color_brewer(palette = "Set1"))
```
???????
```{r Chromosome_manhattan_plot, echo=FALSE, warning=FALSE}
Pvalues <- readRDS("p_values.rds")
Pval <- Pvalues %>% setNames(., c("Position", "P_value"))

#positions_chr <- annot_row[annot_row$chr == "chr1", ]$Name
#chr1 <- Pval[Pval$Position %in% positions_chr,]
#chr1

#ch1 <- data.frame(CHR = c(rep(1, length(annot_row[annot_row$chr == "chr1", ]$Name))),
#                  P = chr1$P_value)
#annot_row[annot_row$chr == "chr1", ]
#colnames(annot_row)
```

# 2. Daugkartinio testavimo p verčių korekcija

```{r P_value_corrections, echo=FALSE, message=FALSE, warning=FALSE}
fdr <- p.adjust(Pval$P_value, method = "fdr", n = length(Pval$P_value))
bf <- p.adjust(Pval$P_value, method = "bonferroni", n = length(Pval$P_value))

p_corr <- data.frame(Position = Pval$Position, No_correction = Pval$P_value,
                     FDR = fdr, Bonferroni = bf)

positions <- data.table(correction = c("Be korekcijos","FDR","Bonferroni"),
   position_count = c(length(rownames(p_corr[p_corr$No_correction <= 0.05, ])),
                      length(rownames(p_corr[p_corr$FDR <= 0.05, ])),
                      length(rownames(p_corr[p_corr$Bonferroni <= 0.05, ]))))

print(positions)
```

# 3. Gene Ontology Enrichment analizė
# Genų sąrašas pozicijoms, turinčioms patikimas p vertes po FDR korekcijos.

```{r GO_analysis_selected_genes_by_p, warning=FALSE, include=FALSE}
# Extracting 'UCSC_RefGene_Name' column values of positions that have a p value
# which is lower or equal to 0.05 after performing FDR correction:
selected_pos <- p_corr[p_corr$FDR <= 0.05, 1] %>% 
                  annot_row[.,]
fgenes <- c(unique(selected_pos$UCSC_RefGene_Name)) %>%
               stri_remove_empty(., na_empty = FALSE)

# Handling lines with gene name repetitions:
modify_lines <- function(x) {
      if (grepl(";", x) == TRUE) {
        smatch <- str_match(x, pattern = regex("([a-zA-Z0-9]*);",
                                               ignore_case = T))
        smatch[1, 1] %>% substr(., 1, nchar(.) - 1)
      } else { x }
}

# Making a unique "foreground" gene name list:
flist <- lapply(fgenes, modify_lines)
fgene_list <- data.table(Genes = unique(unlist(flist)))

write.table(fgene_list, file = "foreground_gene_list.txt", quote = FALSE,
            col.names = FALSE, row.names = FALSE)
```

# Pilnas genų sąrašas
# Įskaitomi visi genai, nepaisant to, kiek patikimos yra juos atitinkančios
# pozicijos.

```{r GO_analysis_all_genes, warning=FALSE, include=FALSE}
# Extracting 'UCSC_RefGene_Name' column values for the entire positions:
bgenes <- c(unique(annot_row$UCSC_RefGene_Name)) %>%
               stri_remove_empty(., na_empty = FALSE)

# Making a unique "background" gene name list:
blist <- lapply(bgenes, modify_lines)
bgene_list <- data.table(Genes = unique(unlist(blist)))

write.table(bgene_list, file = "background_gene_list.txt", quote = FALSE,
            col.names = FALSE, row.names = FALSE)
```

