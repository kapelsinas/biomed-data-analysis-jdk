---
title: "Praktinė užduotis Nr. 3"
author: "Jaroslav Rutkovskij, Danielė Stasiūnaitė, Karolis Augustauskas (JDK)"
date: "`r format(Sys.time(), '%d/%m/%y')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
subtitle: Hipotezių testavimas
---

```{r Figure_size, include=FALSE}
knitr::opts_chunk$set(fig.height = 13, fig.width = 16)
```

```{r Preparations, warning=FALSE, include=FALSE}
library(pacman)
p_load(dplyr, ggplot2)
```

```{r Data_access, warning=FALSE, include=FALSE}
beta <- readRDS("dat8.Rds")               # Modification value matrix
pData_col <- readRDS("pData.Rds")         # Sample (column) matrix
annot_row <- readRDS("annotation.Rds")    # Position (row) matrix
samples <- read.csv("samples2.csv")

colnames(beta) <- samples$graph_name[match(colnames(beta), samples$Basename)]
```

# 1. Statistinis hipotezių testavimas vidurkių palyginimui

### APRAŠYMO VIETA ###
# Aprašyti, kiek moterų įeina į aspiriną vartojančių ir aspirino nevartojančių
# moterų grupes (atlikus ankstesnes užduotis dalis mėginių buvo pašalinta, tad
# dabar aspiriną vartojančių ir nevartojančių moterų skaičius yra pakitęs)!!!

# Pateikti lentelę, kiek moterų įeina į asprino nevartojančių ir aspiriną
# vartojančių moterų grupes (prieš ir po (čia turima omenyje, kiek moterų įėjo
# į tas pačias grupes prieš mėginių šalinimą ir atlikus mėginių šalinimą))

```{r Aspirin_user/nonuser_selection}
# Extracting data frame rows that describe aspirin non-users:
aspirin_nonusers <- samples[samples$aspirin == 'nonuser', ]$graph_name

# Extracting data frame rows that describe aspirin longterm users:
aspirin_users <- samples[samples$aspirin == 'longterm', ]$graph_name

# Extracting matrix columns that store aspirin non-user modification values
# (from beta matrix):
beta_nonusers <- beta[, colnames(beta) %in% aspirin_nonusers]

# Extracting matrix columns that store aspirin non-user modification values
# (from beta matrix):
beta_users <- beta[, colnames(beta) %in% aspirin_users]
```

# T.test. Reikalingas trumpas paaiškinimas, kodėl jį atliekam ir ką
# jis duoda (aiškinti kaip medikui, o ne kaip dėstytojui).

# Efekto dydžio skaičiavimas. Truputį aprašyti, kas tas efekto dydis,
# kodėl jį atliekam ir nurodyti, kad yra toks Cohen's d testas, leidžiantis
# apskaičiuoti efekto dydį. Jokių būdu neaprašinėti techniškai, bet aiškiai
# ir suprantamai, paaiškinant pagrindinę esmę.

```{r T_test_effect_size_calculations}
# Creating an empty dataframes that will store p values and effect sizes
# for each position:
pvalues <- data.frame()
effect_sizes <- data.frame()

# Running a loop that performs t-test, effect size calculations and appends
# p-values, effect size values into dataframes:
for (row in 1:10000) {
  vec1 <- c(beta_nonusers[row, ])
  vec2 <- c(beta_users[row, ])
  rowname <- rownames(beta_nonusers)[row]
  
  row_pvalue <- c(rowname, t.test(vec1, vec2)$p.value)
  effect_size <- c(rowname, (mean(vec1) - mean(vec2)) /
                     sqrt((var(vec1) + var(vec2)) / 2))
  #print(row_pvalue)
  #print(effect_size)
  effect_sizes <- rbind(effect_sizes, effect_size)
  pvalues <- rbind(pvalues, row_pvalue)
}

pvalues <- pvalues %>% setNames(., c("Position", "P_value"))
effect_sizes <- effect_sizes %>% setNames(., c("Position", "Effect_size"))
```

# Paaiškinti, ką atvaizduoja ši histograma, interpretuoti ją ir panašiai.

```{r Plot_preparations}
values <- as.numeric(pvalues$P_value)
p_df <- data.frame(positions = c(pvalues$Position), pvals = values)

p1 <- ggplot(p_df, aes(x = pvals)) + 
        geom_histogram(binwidth = 0.025, color = "#00004d", fill = "#2f4581") +
        labs(x = "P value", y = "Count",
             title = "P-value distribution histogram") +
        theme(axis.text.x = element_text(vjust = 0.5),
              plot.title = element_text(hjust = 0.5, face = "bold"),
              panel.background = element_rect(colour = "#05076a", size = 0.5,
                                              fill = "#eaeafd",
                                              linetype = "solid"),
              panel.grid.major = element_line(size = 0.1, linetype = 'dashed',
                                              colour = "#05076a"), 
              panel.grid.minor = element_line(size = 0.1, linetype = 'dashed',
                                              colour = "#05076a"))
p1
```
