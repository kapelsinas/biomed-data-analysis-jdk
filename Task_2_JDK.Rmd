---
title: "Practical No. 2"
author: "Jaroslav Rutkovskij, Danielė Stasiūnaitė, Karolis Augustauskas (JDK)"
date: "3/18/2022"
output: pdf_document
---
```{r Preparations, message=FALSE, warning=FALSE, include=FALSE}
options(scipen = 1, digits = 3)

#Installing missing packages:
if(length(new.packages)) install.packages(new.packages)
install.packages("Rtools")

# Loading used libraries:
library(minfi)
library(IlluminaHumanMethylationEPICmanifest)
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("IlluminaHumanMethylationEPICanno.ilm10b4.hg19")
```

```{r Preparations_Task, message=FALSE, warning=FALSE, include=FALSE}
# To load the data
load("objects.Rdata")
```

```{r Preparations_Task_QC, message=FALSE, warning=FALSE, include=FALSE}

if (!file.exists("objects.Rdata")) {
  
  ################################################################################################
  # 1.  Pasiruoškite sau paskirtus sample-key failus (apvalydami reikšmes, panašiai kaip aptarėme
  #     paskaitų metu)
  #     - sample-key nuskaitymui R galite naudoti read.csv() funkciją.
  # Importing data:
  ################################################################################################
  
  if (file.exists("data.csv")) {
    data <- read.csv("data.csv")
    # Changing column letters into lower case:
    names(data) <- tolower(names(data))
  }
  
  ################################################################################################
  # 2.  Nuskaitykite parsisiųstus idat failus į "RGChannelSet" tipo objektą
  #     - tam naudokite `read.metharray.exp()` funkcią iš R minfi bibliotekos
  #     - ši funkcija kaip argumentą naudoja "sample-key" lentelę, kurioje stulpelis Basename
  #       turi rodyti į failo vietą jūsų kompiuteryje (galite paskaityti šios funkcijos help()).
  #     - nuskaičius duomenis gautą objektą išsaugokite su saveRDS()
  #     - vėliau jį pasikrauti į atmintį galėsite su readRDS() funkcija
  ################################################################################################
  
  rgSet <- read.metharray.exp(base = "IDATS")
  
  ################################################################################################
  # 3.  Gaukite "detection p-value" kiekvienam DNR modifikacijos įverčiui
  #     - naudokite funkciją `detectionP()` iš minfi
  #     - ši funkcija grąžins įverčių matricą (vienas ivertis vienai modifikacijos reiksmei)
  #       parodanti ar matuojamas intensyvumas skiriasi nuo background
  ################################################################################################
  
  detP <- detectionP(rgSet)
  
  #     - visas vertes kuriu p-verte didesne uz 0.01 laikykite "blogomis"
  
  badPValues <- colMeans(detP) > 0.01
  keep <- colMeans(detP) < 0.01
  # Nieko neišsimetė
  
  #     - is RGChannelSet objekto ismeskite visus meginius (stulpelius) kurie turi daugiau
  #       nei 1% "blogu" detection p reiksmiu.
  #     - PAGALBA: is RGChannelSet objekto reiksmes ismesti galima taip, kaip ir is
  #       matricos: `myData[,-1]` - ismestu pirma megini (stulpeli)
  rgSet <- rgSet[, keep]
  data <- data[keep,]
  detP <- detP[, keep]
  
}
```

```{r Preparations_Task_Normalization, message=FALSE, warning=FALSE, include=FALSE}

####################################################################################################
# 4.  Normalizuokite savo duomenis
#     - naudokite viena is siu funkciju: preprocessSWAN(), preprocessFunnorm() or
#       preproccessIllumina() is "minfi" bibliotekos.
#     - galite pasirinkti laisvai, apie tai kuo skiriasi sie normalizavimo budai galite
#       pasiskaityti siu funkciju help() dokumentacijoje.
####################################################################################################
mSetSq <- preprocessFunnorm(rgSet) # It was used in the research

mSetRaw <- preprocessRaw(rgSet)

####################################################################################################
# 7.  Pašalinkite meginius kuriu nurodyta lytis skiriasi nuo spejamos lyties (spejimus galite gauti
#     su funkcija getSex()).
####################################################################################################

estSex <- getSex(mSetSq)
estSex$predictedSex == 'F'
# Vien moterų mėginiai

####################################################################################################
# 5.  Išmeskite visas genomines pozicijas (eilutes) kurios turi daugiau nei 1% "blogų" detection
#     p reikšmių
#     - detection p-reikėes paskaičiuojamos prieš normalizaciją, taigi naudokite prieš tai
#       paskaičiuotą p-reiksmių matricą.
#     - jeigu iš nuskaityto objekto buvo pašalinta pavyzdžių - nepamirškite prieš atliekant šį
#       žingsnį jų pašalinti ir iš detection p-reiksmių matricos.
#     - PAGALBA: normalizavimo žingsnis gali pašalinti kai kurias genomines pozicijas (eilutes)
#       iš nuskaityto objekto, todėl naudokite
#     `rownames()`, kad sužinotumėte, kurios pozicijos turi būti pašalintos.
# ensure probes are in the same order in the mSetSq and detP objects
####################################################################################################

# ensure probes are in the same order in the mSetSq and detP objects
detP <- detP[match(featureNames(mSetSq), rownames(detP)), ]

# remove any probes that have failed in one or more samples
keep <- rowSums(detP < 0.01) == ncol(mSetSq)

table(keep)
## keep
##  FALSE   TRUE
##  9713    856146

mSetSqFlt <- mSetSq[keep, ]
mSetSqFlt

####################################################################################################
# 6.  Išmeskite genomines pozicijas (eilutes) neturinčias "CG" nukleotidų poros (CH) arba esančias
#     šalia DNR polimorfizmų
#     - tam naudokite funkciją dropMethylationLoci(), galite perskaityti jos help().
####################################################################################################

mSetSqFlt <- dropMethylationLoci(mSetSqFlt, dropCH = TRUE)

####################################################################################################
# 8.  Po duomenų paruošimo iš gauto objekto pasidarykite tris atskirus objektus:
#     - pagrindinė modifikacijos įverčių matrica: getBeta()
#     - informacija apie pagrindinės matricos mėginius (stulpelius): pData()
#     - informacija apie pagrindinės matricos pozicijas (eilutes): getAnnotation()
####################################################################################################

beta <- getBeta(mSetSqFlt)
pData <- pData(mSetSqFlt)
annotation <- getAnnotation(mSetSqFlt)

####################################################################################################
# 9.  Savarankiškai parašykite kodą, atliekantį IAC išskirčių išmetimą.
#     - Detalus sios proceduros aprasymas, net su kodo pavyzdziais, gali buti rastas cia:
#     https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/HumanBrainTranscriptome/Identification%20and%20Removal%20of%20Outlier%20Samples.pdf)
####################################################################################################



####################################################################################################
# 10. Atlikite bent vieną kokybės kontrolės žingsnį aptartą paskaitų metu, arba susigalvotą savo
#     paties (žinoma galite atlikti ir daugiau nei vieną).
####################################################################################################

####################################################################################################
# 11. Išsisaugokite paruoštus duomenis (su saveRDS()), juos naudosite kitose užduotyse
####################################################################################################
# Save multiple objects
# save.image(file = "objects.Rdata")
# save(data, detP, mSetRaw, mSetSq, rgSet, badPValues, beta, pData, annotation, keep, file="objects.Rdata")
# save(beta, file="beta.Rdata")
# save(pData, file="pData.Rdata")
# save(annotation, file="annotation.Rdata")
# load("beta.Rdata")
```
